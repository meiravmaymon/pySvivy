{% extends "base.html" %}

{% block title %}שלב 5 - סיום ולידציה{% endblock %}

{% block extra_css %}
<style>
    .summary-card {
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
    }
    .change-category {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border-right: 4px solid #3182ce;
    }
    .change-category.has-changes {
        border-right-color: #f6ad55;
    }
    .change-count {
        background: #f6ad55;
        color: #744210;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.85em;
        margin-right: 10px;
    }
    .change-count.zero {
        background: #e2e8f0;
        color: #718096;
    }
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
    }
    .btn-finalize {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 25px;
        font-size: 1.2em;
        font-weight: bold;
        transition: all 0.3s;
    }
    .btn-finalize:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        color: white;
    }
    .btn-finalize:disabled {
        background: #e2e8f0;
        color: #718096;
        transform: none;
        box-shadow: none;
        cursor: not-allowed;
    }
    .btn-discard {
        background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 1em;
        transition: all 0.3s;
    }
    .btn-discard:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(252, 129, 129, 0.4);
        color: white;
    }
    .btn-back {
        background: #e2e8f0;
        color: #4a5568;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 1em;
    }
    .warning-box {
        background: #fef3c7;
        border: 1px solid #f6ad55;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .success-box {
        background: #c6f6d5;
        border: 1px solid #48bb78;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .meeting-header {
        background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
    }
</style>
{% endblock %}

{% block content %}
<script>const SID = '{{ sid }}';</script>

<div class="meeting-header text-center">
    <h2><i class="bi bi-check2-circle"></i> סיום ולידציה</h2>
    <p class="mb-0">ישיבה {{ meeting_info.meeting_no }} | {{ meeting_info.meeting_date }}</p>
</div>

{% if pending_count == 0 %}
<div class="success-box text-center">
    <i class="bi bi-info-circle fs-4"></i>
    <h4 class="mt-2">אין שינויים ממתינים</h4>
    <p class="mb-0">כל השינויים כבר נשמרו לבסיס הנתונים, או שלא בוצעו שינויים.</p>
</div>
{% else %}
<div class="warning-box">
    <i class="bi bi-exclamation-triangle"></i>
    <strong>שים לב:</strong> יש {{ pending_count }} שינויים ממתינים שטרם נשמרו לבסיס הנתונים.
    לחץ על "שמור הכל" כדי לשמור את כל השינויים, או "בטל הכל" לביטול.
</div>
{% endif %}

<div class="summary-card">
    <h4><i class="bi bi-list-check"></i> סיכום שינויים</h4>
    <hr>

    <!-- Meeting changes -->
    <div class="change-category {% if pending.meeting %}has-changes{% endif %}">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-calendar-event"></i>
                <strong>פרטי ישיבה</strong>
            </div>
            <span class="change-count {% if not pending.meeting %}zero{% endif %}">
                {% if pending.meeting %}1{% else %}0{% endif %}
            </span>
        </div>
        {% if pending.meeting %}
        <small class="text-muted">
            {% if pending.meeting.meeting_no %}מספר: {{ pending.meeting.meeting_no }}{% endif %}
            {% if pending.meeting.meeting_date %} | תאריך: {{ pending.meeting.meeting_date }}{% endif %}
            {% if pending.meeting.meeting_type %} | סוג: {{ pending.meeting.meeting_type }}{% endif %}
        </small>
        {% endif %}
    </div>

    <!-- Attendance changes -->
    <div class="change-category {% if pending.attendances %}has-changes{% endif %}">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-people"></i>
                <strong>נוכחות</strong>
            </div>
            <span class="change-count {% if not pending.attendances %}zero{% endif %}">
                {{ pending.attendances|length if pending.attendances else 0 }}
            </span>
        </div>
    </div>

    <!-- Staff changes -->
    <div class="change-category {% if pending.staff %}has-changes{% endif %}">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-person-badge"></i>
                <strong>סגל חדש</strong>
            </div>
            <span class="change-count {% if not pending.staff %}zero{% endif %}">
                {{ pending.staff|length if pending.staff else 0 }}
            </span>
        </div>
        {% if pending.staff %}
        <small class="text-muted">
            {% for s in pending.staff[:3] %}{{ s.name }}{% if not loop.last %}, {% endif %}{% endfor %}
            {% if pending.staff|length > 3 %}ועוד {{ pending.staff|length - 3 }}...{% endif %}
        </small>
        {% endif %}
    </div>

    <!-- Discussion updates -->
    <div class="change-category {% if pending.discussions %}has-changes{% endif %}">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-chat-square-text"></i>
                <strong>עדכון סעיפים</strong>
            </div>
            <span class="change-count {% if not pending.discussions %}zero{% endif %}">
                {{ pending.discussions|length if pending.discussions else 0 }}
            </span>
        </div>
    </div>

    <!-- New discussions -->
    <div class="change-category {% if pending.new_discussions %}has-changes{% endif %}">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-plus-circle"></i>
                <strong>סעיפים חדשים</strong>
            </div>
            <span class="change-count {% if not pending.new_discussions %}zero{% endif %}">
                {{ pending.new_discussions|length if pending.new_discussions else 0 }}
            </span>
        </div>
        {% if pending.new_discussions %}
        <small class="text-muted">
            {% for d in pending.new_discussions[:3] %}סעיף {{ d.issue_no }}{% if not loop.last %}, {% endif %}{% endfor %}
            {% if pending.new_discussions|length > 3 %}ועוד {{ pending.new_discussions|length - 3 }}...{% endif %}
        </small>
        {% endif %}
    </div>
</div>

<div class="action-buttons">
    <a href="/step/4c?sid={{ sid }}" class="btn btn-back">
        <i class="bi bi-arrow-right"></i>
        חזור לשלב קודם
    </a>
    {% if pending_count > 0 %}
    <button onclick="discardValidation()" class="btn btn-discard">
        <i class="bi bi-x-circle"></i>
        בטל הכל
    </button>
    <button onclick="finalizeValidation()" class="btn btn-finalize">
        <i class="bi bi-check2-all"></i>
        שמור הכל לבסיס הנתונים
    </button>
    {% else %}
    <a href="/?sid={{ sid }}" class="btn btn-finalize">
        <i class="bi bi-house"></i>
        חזור לדף הראשי
    </a>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// Functions are defined in base.html
</script>
{% endblock %}
